---
- name: Enable Wake-on-LAN for all Ethernet connections
  hosts: "{{ target | default('cagelab_servers') }}"
  gather_facts: false
  become: true
  ignore_unreachable: true

  vars:
    wol_methods: "phy,unicast,multicast,broadcast,arp,magic"

  tasks:
    - name: Ensure nmcli exists
      ansible.builtin.command:
        argv: ["bash", "-lc", "command -v nmcli"]
      changed_when: false

    - name: List NetworkManager connections
      ansible.builtin.command:
        argv: ["nmcli", "-t", "-f", "NAME", "connection", "show"]
      register: nm_connections
      changed_when: false

    - name: Build connection list
      ansible.builtin.set_fact:
        connections: "{{ nm_connections.stdout_lines | reject('equalto', '') | list }}"

    - name: Query connection types
      ansible.builtin.command:
        argv: ["nmcli", "-g", "connection.type", "connection", "show", "{{ item }}"]
      loop: "{{ connections }}"
      register: conn_types
      changed_when: false
      failed_when: false

    - name: Filter ethernet connections
      ansible.builtin.set_fact:
        ethernet_connections: >-
          {{ conn_types.results
             | selectattr('stdout', 'match', '^(ethernet|802-3-ethernet)$')
             | map(attribute='item')
             | list }}

    - name: Read current WoL mode for ethernet connections
      ansible.builtin.command:
        argv: ["nmcli", "-g", "802-3-ethernet.wake-on-lan", "connection", "show", "{{ item }}"]
      loop: "{{ ethernet_connections }}"
      register: wol_current
      changed_when: false
      failed_when: false

    - name: Enable WoL (set 802-3-ethernet.wake-on-lan)
      ansible.builtin.command:
        argv:
          - "nmcli"
          - "connection"
          - "modify"
          - "{{ item.item }}"
          - "802-3-ethernet.wake-on-lan"
          - "{{ wol_methods }}"
      loop: "{{ wol_current.results }}"
      when: (item.stdout | default('')) != wol_methods
      changed_when: true

    - name: Bring ethernet connections up (apply settings)
      ansible.builtin.command:
        argv: ["nmcli", "connection", "up", "{{ item }}"]
      loop: "{{ ethernet_connections }}"
      changed_when: false
      failed_when: false

    - name: Show final WoL mode
      ansible.builtin.command:
        argv: ["nmcli", "-g", "802-3-ethernet.wake-on-lan", "connection", "show", "{{ item }}"]
      loop: "{{ ethernet_connections }}"
      register: wol_final
      changed_when: false
      failed_when: false

    - name: Report WoL status
      ansible.builtin.debug:
        msg: "{{ item.item }} => {{ item.stdout | default('unknown') }}"
      loop: "{{ wol_final.results }}"